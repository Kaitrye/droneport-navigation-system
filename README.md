# ๐ Droneport System โ ะกะธััะตะผะฐ ัะฟัะฐะฒะปะตะฝะธั ะดัะพะฝะพะฟะพััะพะผ

ะัะพะฝะพะฟะพัั โ ัะตัะฒะธั ะฝะฐะทะตะผะฝะพะน ะธะฝััะฐััััะบัััั ะดะปั ะฟัะธัะผะฐ, ะพะฑัะปัะถะธะฒะฐะฝะธั ะธ ะทะฐััะดะบะธ ะฐะณัะพะดัะพะฝะพะฒ. 

---

## ๐ ะะฐะทะฝะฐัะตะฝะธะต

ะกะธััะตะผะฐ ัะตะฐะปะธะทัะตั ััะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั ะบ ะดัะพะฝะพะฟะพััั:

| ะขัะตะฑะพะฒะฐะฝะธะต | ะะฟะธัะฐะฝะธะต |
|------------|----------|
| **ะะค1** | ะัะธัะผ ะดัะพะฝะพะฒ: ะฟัะพะฒะตัะบะฐ ะทะฐะฟัะพัะฐ ะฟะพัะฐะดะบะธ, ัะตะณะธัััะฐัะธั ะดัะพะฝะฐ ะฒ ะฟะฐัะบะต, ะบะพะฝััะพะปั ะทะฐะฝััะพััะธ ะฟะพัะฐะดะพัะฝัั ะฟะปะพัะฐะดะพะบ |
| **ะะค2** | ะะฑัะปัะถะธะฒะฐะฝะธะต ะดัะพะฝะพะฒ: ะฟะพะดะณะพัะพะฒะบะฐ ะบ ะฒัะปะตัั, ะพัะฒะพะฑะพะถะดะตะฝะธะต ะฟะปะพัะฐะดะบะธ ะฟะพัะปะต ะฒะทะปััะฐ |
| **ะะค3** | ะะตะฝะตัะฐัะธั ัะฟะธัะบะฐ ะดัะพะฝะพะฒ: ัะพัะผะธัะพะฒะฐะฝะธะต ะฐะบััะฐะปัะฝะพะณะพ ัะตะตัััะฐ ะฒัะตั ะดัะพะฝะพะฒ ะฒ ะดัะพะฝะพะฟะพััั ั ะธั ัะพััะพัะฝะธะตะผ |
| **ะะค4** | ะะธะฐะณะฝะพััะธะบะฐ: ะผะพะฝะธัะพัะธะฝะณ ััะพะฒะฝั ะทะฐััะดะฐ ะฑะฐัะฐัะตะธ, ะฒััะฒะปะตะฝะธะต ะฝะตะธัะฟัะฐะฒะฝะพััะตะน, ัะพัะผะธัะพะฒะฐะฝะธะต ัะตะปะตะน ะฑะตะทะพะฟะฐัะฝะพััะธ |
| **ะะะค1** | ะะฟัะธะผะธะทะฐัะธั ะทะฐััะดะบะธ: ัะฐัััั ะผะพัะฝะพััะธ ะทะฐััะดะบะธ ั ััััะพะผ ะฒัะตะผะตะฝะธ ะฒัะปะตัะฐ ะธ ัะตัะฝะธัะตัะบะธั ะพะณัะฐะฝะธัะตะฝะธะน |

---

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ะกะธััะตะผะฐ ะัะพะฝะพะฟะพััะฐ                        โ
โ  (systems/droneport_system/src/droneport_system.py)         โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
               โ                          โ
               โ SystemBus (Kafka/MQTT)   โ
               โผ                          โผ
    โโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ
    โ   ะะฃะก (GCS)      โ      โ   ะัะบะตัััะฐัะพั    โ
    โ (ะทะฐะฟัะพั ะฟะพัะฐะดะบะธ) โ      โ (ะฟะปะฐะฝะธัะพะฒะฐะฝะธะต)   โ
    โโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ
```

### ะะปััะตะฒัะต ะฟัะธะฝัะธะฟั

- **ะกะตัะฒะธัะฝะพ-ะพัะธะตะฝัะธัะพะฒะฐะฝะฝะฐั ะฐััะธัะตะบัััะฐ** (ััะตะฑะพะฒะฐะฝะธะต ะ2 ะขะ): ะดัะพะฝะพะฟะพัั โ ะฝะตะทะฐะฒะธัะธะผัะน ัะตัะฒะธั, ะฒะทะฐะธะผะพะดะตะนััะฒัััะธะน ั ะดััะณะธะผะธ ัะธััะตะผะฐะผะธ **ัะพะปัะบะพ ัะตัะตะท ะฑัะพะบะตั ัะพะพะฑัะตะฝะธะน** (`SystemBus`).
- **Stateless-ะปะพะณะธะบะฐ**: ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ ะพัะดะตะปะตะฝะฐ ะพั ัะพััะพัะฝะธั. ะกะพััะพัะฝะธะต (ัะฟะธัะพะบ ะดัะพะฝะพะฒ, ะฟะปะพัะฐะดะพะบ) ััะฐะฝะธััั ะฒะพ ะฒะฝัััะตะฝะฝะตะผ in-memory ััะฐะฝะธะปะธัะต (ะดะปั ะฟัะพัะพัะธะฟะฐ) ะธะปะธ ะผะพะถะตั ะฑััั ะฒัะฝะตัะตะฝะพ ะฒ Redis/PostgreSQL (ะดะปั production).
- **ะกะะะ-ัะพะฒะผะตััะธะผะพััั**: ะฒัะต ะฒัะพะดััะธะต ัะพะพะฑัะตะฝะธั ะฟัะพัะพะดัั ะฒะฐะปะธะดะฐัะธั, ะพัะฒะตัั ัะพะดะตัะถะฐั ะบะพะดั ะพัะธะฑะพะบ, ะปะพะณะธัััััั ะบัะธัะธัะตัะบะธะต ะพะฟะตัะฐัะธะธ (ะฟะพัะฐะดะบะฐ/ะฒะทะปัั).

---

## ๐ก ะะพะดะดะตัะถะธะฒะฐะตะผัะต ะดะตะนััะฒะธั (Actions)

ะัะต ะดะตะนััะฒะธั ะฟัะฑะปะธะบััััั ะฒ ัะพะฟะธะบ `systems.droneport` (ัะผ. `shared/topics.py` โ `DroneportActions`).

| Action | Payload | ะัะฒะตั | ะะฐะทะฝะฐัะตะฝะธะต |
|--------|---------|-------|------------|
| `REQUEST_LANDING` | `{"drone_id": str, "port_id": str, "battery_level": float}` | `{"status": "landed"\|"rejected", "drone_id": str, "port_id": str, "message": str}` | ะะตะณะธัััะฐัะธั ะดัะพะฝะฐ ะฟัะธ ะฟะพัะฐะดะบะต |
| `REQUEST_TAKEOFF` | `{"drone_id": str}` | `{"status": "takeoff_approved"\|"not_found", "drone_id": str, "battery_level": float}` | ะัะฒะพะฑะพะถะดะตะฝะธะต ะฟะปะพัะฐะดะบะธ ะฟะพัะปะต ะฒะทะปััะฐ |
| `START_CHARGING` | `{"drone_id": str, "target_battery": float, "departure_time_sec": int}` | `{"status": "charging_started", "charging_power_w": float, "estimated_finish_sec": int}` | ะะฐะฟััะบ ะพะฟัะธะผะธะทะธัะพะฒะฐะฝะฝะพะน ะทะฐััะดะบะธ |
| `STOP_CHARGING` | `{"drone_id": str}` | `{"status": "charging_stopped", "drone_id": str}` | ะัะธะฝัะดะธัะตะปัะฝะฐั ะพััะฐะฝะพะฒะบะฐ ะทะฐััะดะบะธ |
| `GET_PORT_STATUS` | `{"filter": "all"\|"landed"\|"charging"}` | `{"drones": [...], "total": int, "timestamp": float}` | ะะพะปััะตะฝะธะต ัะฟะธัะบะฐ ะดัะพะฝะพะฒ ั ะดะธะฐะณะฝะพััะธะบะพะน |

### ะคะพัะผะฐั ะพัะฒะตัะฐ `GET_PORT_STATUS`

```json
{
  "drones": [
    {
      "drone_id": "AGRO-042",
      "port_id": "PAD-03",
      "battery_level": 15.0,
      "status": "landed",
      "safety_target": "low_battery_alert",
      "issues": ["battery_critical"],
      "last_landing_time": 1739876543.123,
      "charging_power_w": 0.0
    }
  ],
  "total": 1,
  "timestamp": 1739876599.456
}
```

ะะพะปั `safety_target` ะธ `issues` ัะตะฐะปะธะทััั ััะตะฑะพะฒะฐะฝะธะต **ะะค4** (ะดะธะฐะณะฝะพััะธะบะฐ ะธ ัะตะปะธ ะฑะตะทะพะฟะฐัะฝะพััะธ).

---

## ๐ ะะฐะฟััะบ ัะธััะตะผั

### ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ

```bash
# 1. ะะพะดะฝััั ะฑัะพะบะตั (Kafka ะธะปะธ MQTT)
docker-compose -f broker/docker-compose.yaml up -d

# 2. ะะฐะฟัััะธัั ะดัะพะฝะพะฟะพัั
export SYSTEM_TYPE=droneport
export SYSTEM_ID=droneport_main
export HEALTH_PORT=9801
python -m systems
```

### ะะฐะฟััะบ ะฒ Docker

```bash
# ะกะฑะพัะบะฐ ะพะฑัะฐะทะฐ
docker build -t droneport:latest -f systems/droneport_system/Dockerfile .

# ะะฐะฟััะบ ัะตัะตะท docker-compose (ะฟัะธะผะตั ััะฐะณะผะตะฝัะฐ)
# ะ ะบะพัะฝะตะฒะพะผ docker-compose.yaml ะดะพะฑะฐะฒะธัั:
#
#  droneport:
#    image: droneport:latest
#    environment:
#      - SYSTEM_TYPE=droneport
#      - SYSTEM_ID=droneport_01
#      - HEALTH_PORT=9801
#      - BROKER_HOST=kafka
#      - BROKER_PORT=9092
#    depends_on:
#      - kafka
```

---

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะฎะฝะธั-ัะตััั

```bash
cd systems/droneport_system
python -m pytest tests/unit/ -v --cov=src --cov-report=html
```

ะะพะบัััะธะต ัะพััะฐะฝัะตััั ะฒ `htmlcov/index.html`.

### ะกะบะฒะพะทะฝะพะน ััะตะฝะฐัะธะน (e2e)

```python
# tests/e2e/test_landing_to_takeoff.py
def test_full_lifecycle(bus):
    # 1. ะะพัะฐะดะบะฐ
    resp = bus.request(
        topic="systems.droneport",
        action="request_landing",
        payload={"drone_id": "D-TEST", "port_id": "P-01", "battery_level": 40.0}
    )
    assert resp["status"] == "landed"

    # 2. ะะฐะฟัะพั ััะฐัััะฐ
    status = bus.request(
        topic="systems.droneport",
        action="get_port_status",
        payload={}
    )
    assert status["total"] == 1
    assert status["drones"][0]["battery_level"] == 40.0

    # 3. ะะทะปัั
    takeoff = bus.request(
        topic="systems.droneport",
        action="request_takeoff",
        payload={"drone_id": "D-TEST"}
    )
    assert takeoff["status"] == "takeoff_approved"
```

---

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
systems/drone_port/
โโโ components/
|   โโโ Dockerfile                   # ะะฑัะฐะท ะดะปั ัะฐะทะฒััััะฒะฐะฝะธั
|   โโโ Makefile                     # ะฆะตะปะธ: build, test, run
|   โโโ requirements.txt             # ะะฐะฒะธัะธะผะพััะธ
โโโ src/
โ   โโโ dronoport.py      # ะัะฝะพะฒะฝะฐั ะปะพะณะธะบะฐ ัะธััะตะผั
โโโ tests/
    โโโ dronoport_tests.py
```

---
